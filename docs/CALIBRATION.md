# Калибровка и тюнинг

## Обзор параметров

| Параметр | Диапазон | Описание |
|----------|----------|----------|
| `confidence_threshold` | 0.1 - 0.9 | Минимальная уверенность детекции |
| `detection_interval` | 1 - 60 сек | Интервал между детекциями |
| `smoothing_alpha` | 0.1 - 1.0 | Коэффициент EMA сглаживания |
| `imgsz` | 480/640/1280 | Размер кадра для inference |

## Калибровка confidence

### Автоматическая калибровка

```bash
cd scripts

# С известным количеством людей
python calibrate.py --source rtsp://... --known-count 50 --samples 20

# Без известного количества (оценка стабильности)
python calibrate.py --source rtsp://... --samples 20
```

### Ручная калибровка

1. Откройте Settings → Детекция
2. Установите `confidence = 0.30`
3. Сравните подсчёт с реальным количеством
4. Если система **недосчитывает** → уменьшите confidence
5. Если система **пересчитывает** → увеличьте confidence
6. Повторите до достижения точности ±10%

### Типичные значения

| Сценарий | Confidence | Причина |
|----------|------------|---------|
| Bird's eye view, хорошее освещение | 0.30-0.35 | Люди хорошо видны |
| Bird's eye view, слабое освещение | 0.25-0.30 | Нужен запас |
| Фронтальная камера | 0.35-0.45 | Больше перекрытий |
| Плотная толпа | 0.40-0.50 | Много частичных детекций |

## Калибровка smoothing_alpha

Alpha определяет баланс между отзывчивостью и стабильностью:

```
smoothed = alpha × current + (1 - alpha) × previous
```

| Alpha | Поведение | Применение |
|-------|-----------|------------|
| 0.1 | Очень плавный | Стабильный зал, редкие изменения |
| 0.3 | Сбалансированный | Стандартный вариант |
| 0.5 | Отзывчивый | Быстро меняющийся поток |
| 0.8+ | Мгновенный | Тестирование |

### Рекомендации

- **Сидячий зал (лекция)**: alpha = 0.2, interval = 30 сек
- **Стоячий ивент (networking)**: alpha = 0.4, interval = 10 сек
- **Вход/выход (регистрация)**: alpha = 0.5, interval = 5 сек

## Калибровка detection_interval

| Interval | CPU нагрузка | Применение |
|----------|--------------|------------|
| 1-5 сек | Высокая | Тестирование, быстрые изменения |
| 10-15 сек | Умеренная | Стандартная конференция |
| 30-60 сек | Низкая | Стабильный зал, экономия ресурсов |

### Расчёт нагрузки

```
Детекций в минуту = 60 / interval × количество_камер

Пример: 6 камер × 15 сек интервал = 24 детекции/мин
При ~40ms на детекцию = ~1 сек CPU в минуту
```

## Калибровка imgsz

| Размер | Скорость | Точность | Память |
|--------|----------|----------|--------|
| 480 | Быстро | Хуже | Мало |
| 640 | Оптимально | Хорошо | Средне |
| 1280 | Медленно | Лучше | Много |

**Рекомендация**: Используйте 640 для большинства случаев.

## Примеры конфигураций

### Небольшая конференция (100 человек, 3 зала)

```json
{
  "confidence_threshold": 0.35,
  "detection_interval": 15,
  "smoothing_alpha": 0.3,
  "imgsz": 640
}
```

### Крупное мероприятие (1000+ человек, 10 залов)

```json
{
  "confidence_threshold": 0.40,
  "detection_interval": 30,
  "smoothing_alpha": 0.25,
  "imgsz": 640
}
```

### Демо / тестирование

```json
{
  "confidence_threshold": 0.35,
  "detection_interval": 2,
  "smoothing_alpha": 0.8,
  "imgsz": 640
}
```

## Оценка точности

### Ожидаемая точность

| Условия | Точность |
|---------|----------|
| Идеальные (bird's eye, хорошее освещение) | 90-95% |
| Хорошие (bird's eye, среднее освещение) | 85-90% |
| Сложные (фронтальная камера, перекрытия) | 70-85% |
| Очень сложные (плотная толпа) | 60-75% |

### Факторы, влияющие на точность

**Улучшают точность:**
- Потолочное размещение камеры
- Хорошее равномерное освещение
- Контрастная одежда посетителей
- Субпоток 1080p (достаточно детализации)

**Ухудшают точность:**
- Фронтальное размещение камеры
- Слабое / неравномерное освещение
- Перекрытия людей друг другом
- Похожая на фон одежда

## Мониторинг качества

### Через UI

1. Откройте страницу зала
2. Смотрите Live Preview — bbox должны точно обрамлять людей
3. Сравнивайте `count` и `raw_count` — большая разница указывает на нестабильность

### Через API

```bash
# Текущий статус
curl http://localhost:8000/api/rooms/hall-1/current

# История для анализа
curl "http://localhost:8000/api/rooms/hall-1/history?hours=2"
```

## Troubleshooting

### Постоянный пересчёт

**Симптом**: count скачет (50 → 65 → 48 → 70)

**Решения**:
1. Уменьшить alpha (0.3 → 0.2)
2. Увеличить interval
3. Проверить стабильность освещения

### Постоянный недосчёт

**Симптом**: система показывает 30, реально 50

**Решения**:
1. Уменьшить confidence (0.35 → 0.25)
2. Увеличить imgsz (640 → 1280)
3. Улучшить освещение

### Ложные срабатывания

**Симптом**: детекция объектов, похожих на людей

**Решения**:
1. Увеличить confidence (0.35 → 0.45)
2. Проверить angle камеры
3. Убрать из кадра манекены/постеры с людьми
